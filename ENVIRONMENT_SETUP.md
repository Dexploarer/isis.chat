# ISIS Chat Environment Configuration Guide

This guide explains how to properly configure environment variables for the ISIS Chat application's SOL-based subscription system.

## Overview

ISIS Chat uses environment variables for all configuration to ensure:
- **No hardcoded values** in the codebase
- **Security** - sensitive data stays out of version control
- **Flexibility** - easy deployment across different environments
- **Best practices** - follows industry standards for configuration management

## Environment Files

### Frontend Configuration (`apps/web/.env.local`)

Copy `apps/web/.env.example` to `apps/web/.env.local` and configure:

```bash
# Required for production
NEXT_PUBLIC_SOLANA_PAYMENT_ADDRESS=YOUR_ACTUAL_SOLANA_WALLET_ADDRESS
NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud

# Convex Auth Configuration (Generated by npx @convex-dev/auth)
JWT_PRIVATE_KEY=your-generated-jwt-private-key
JWKS=your-generated-jwks-configuration
SITE_URL=http://localhost:3001

# OAuth Providers (Optional - configure as needed)
# AUTH_GITHUB_ID=your-github-client-id
# AUTH_GITHUB_SECRET=your-github-client-secret
# AUTH_GOOGLE_ID=your-google-client-id
# AUTH_GOOGLE_SECRET=your-google-client-secret

# Email Provider for Magic Links (Optional)
# AUTH_RESEND_KEY=your-resend-api-key

# Network configuration
NEXT_PUBLIC_SOLANA_NETWORK=mainnet-beta  # or devnet for testing
NEXT_PUBLIC_SOLANA_RPC_HOST=https://api.mainnet-beta.solana.com

# Pricing (customize as needed)
NEXT_PUBLIC_SUBSCRIPTION_PRO_PRICE_SOL=0.05
NEXT_PUBLIC_SUBSCRIPTION_PRO_PLUS_PRICE_SOL=0.1
NEXT_PUBLIC_SUBSCRIPTION_PRO_PRICE_USD=12
NEXT_PUBLIC_SUBSCRIPTION_PRO_PLUS_PRICE_USD=25

# Payment processing
NEXT_PUBLIC_PAYMENT_TIMEOUT_MS=300000
NEXT_PUBLIC_SOLANA_COMMITMENT=confirmed
```

### Backend Configuration (`packages/backend/.env`)

Copy `packages/backend/.env.example` to `packages/backend/.env` and configure:

```bash
# Required for production
SOLANA_PAYMENT_ADDRESS=YOUR_ACTUAL_SOLANA_WALLET_ADDRESS
OPENAI_API_KEY=sk-your-openai-api-key-here

# Convex Auth Configuration (Generated by npx @convex-dev/auth)
JWT_PRIVATE_KEY=your-generated-jwt-private-key
JWKS=your-generated-jwks-configuration
SITE_URL=http://localhost:3001

# OAuth Providers (Optional - configure as needed)
# AUTH_GITHUB_ID=your-github-client-id
# AUTH_GITHUB_SECRET=your-github-client-secret
# AUTH_GOOGLE_ID=your-google-client-id
# AUTH_GOOGLE_SECRET=your-google-client-secret

# Email Provider for Magic Links (Optional)
AUTH_RESEND_KEY=your-resend-api-key

# Network configuration
SOLANA_NETWORK=mainnet-beta  # or devnet for testing
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com

# Pricing (must match frontend)
SUBSCRIPTION_PRO_PRICE_SOL=0.05
SUBSCRIPTION_PRO_PLUS_PRICE_SOL=0.1

# Message limits
SUBSCRIPTION_FREE_MESSAGE_LIMIT=50
SUBSCRIPTION_PRO_MESSAGE_LIMIT=1500
SUBSCRIPTION_PRO_PLUS_MESSAGE_LIMIT=3000
SUBSCRIPTION_PRO_PREMIUM_LIMIT=100
SUBSCRIPTION_PRO_PLUS_PREMIUM_LIMIT=300

# Security
PAYMENT_WEBHOOK_SECRET=generate-a-secure-256-bit-secret
JWT_SECRET=generate-a-secure-256-bit-secret
```

## Setup Instructions

### 1. Convex Auth Setup

**Initialize Convex Auth** (generates JWT keys and JWKS automatically):

```bash
# For development
cd packages/backend
npx @convex-dev/auth

# For production
npx @convex-dev/auth --prod
```

This command will automatically generate and set the following environment variables in your Convex deployment:
- `JWT_PRIVATE_KEY` - Private key for signing JWT tokens
- `JWKS` - JSON Web Key Set for token verification
- `SITE_URL` - Your application URL for OAuth redirects

**Manual Key Generation** (if automatic setup doesn't work):

```bash
# Create a temporary script to generate keys
node -e "
import { exportJWK, exportPKCS8, generateKeyPair } from 'jose';

const keys = await generateKeyPair('RS256', {
  extractable: true,
});
const privateKey = await exportPKCS8(keys.privateKey);
const publicKey = await exportJWK(keys.publicKey);
const jwks = JSON.stringify({ keys: [{ use: 'sig', ...publicKey }] });

console.log('JWT_PRIVATE_KEY=' + JSON.stringify(privateKey.trimEnd().replace(/\n/g, ' ')));
console.log('JWKS=' + jwks);
" --input-type=module
```

Then set these values using the Convex CLI:
```bash
npx convex env set JWT_PRIVATE_KEY "your-generated-jwt-private-key"
npx convex env set JWKS "your-generated-jwks-configuration"
npx convex env set SITE_URL "http://localhost:3001"
```

### 2. OAuth Provider Setup (Optional)

Configure OAuth providers as needed for your authentication requirements:

#### GitHub OAuth (Optional)
1. **Create GitHub OAuth App**:
   - Go to GitHub Settings → Developer settings → OAuth Apps
   - Create new OAuth app with callback URL: `https://your-deployment.convex.site/api/auth/callback/github`

2. **Set Environment Variables**:
   ```bash
   npx convex env set AUTH_GITHUB_ID your-github-client-id
   npx convex env set AUTH_GITHUB_SECRET your-github-client-secret
   ```

#### Google OAuth (Optional)
1. **Create Google OAuth App**:
   - Go to Google Cloud Console → APIs & Services → Credentials
   - Create OAuth 2.0 client with redirect URI: `https://your-deployment.convex.site/api/auth/callback/google`

2. **Set Environment Variables**:
   ```bash
   npx convex env set AUTH_GOOGLE_ID your-google-client-id
   npx convex env set AUTH_GOOGLE_SECRET your-google-client-secret
   ```

#### Apple OAuth (Optional)
1. **Configure Apple Sign In**:
   - Follow Apple Developer documentation for Sign in with Apple
   - Generate JWT secret as per Apple's requirements

2. **Set Environment Variables**:
   ```bash
   npx convex env set AUTH_APPLE_ID your-apple-service-identifier
   npx convex env set AUTH_APPLE_SECRET your-apple-generated-jwt-secret
   ```

### 3. Email Provider Setup (Optional)

For magic links and password reset emails:

#### Resend Setup (Recommended)
1. **Get Resend API Key**:
   - Sign up at [resend.com](https://resend.com)
   - Create API key in dashboard

2. **Set Environment Variable**:
   ```bash
   npx convex env set AUTH_RESEND_KEY your-resend-api-key
   ```

### 4. Solana Wallet Setup

1. **Create a Solana Wallet** (if you don't have one):
   - Install Phantom or Solflare wallet
   - Create a new wallet and securely store your seed phrase
   - Copy your wallet's public address

2. **Configure Payment Address**:
   ```bash
   # Replace with your actual wallet address
   NEXT_PUBLIC_SOLANA_PAYMENT_ADDRESS=7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU
   SOLANA_PAYMENT_ADDRESS=7xKXtg2CW87d97TXJSDpbD5jBkheTqA83TZRuJosgAsU
   ```

### 5. Network Configuration

#### Development (Devnet)
```bash
NEXT_PUBLIC_SOLANA_NETWORK=devnet
NEXT_PUBLIC_SOLANA_RPC_HOST=https://api.devnet.solana.com
SOLANA_NETWORK=devnet
SOLANA_RPC_URL=https://api.devnet.solana.com
```

#### Production (Mainnet)
```bash
NEXT_PUBLIC_SOLANA_NETWORK=mainnet-beta
NEXT_PUBLIC_SOLANA_RPC_HOST=https://api.mainnet-beta.solana.com
SOLANA_NETWORK=mainnet-beta
SOLANA_RPC_URL=https://api.mainnet-beta.solana.com
```

### 6. Convex Backend Setup

1. **Deploy Convex Backend**:
   ```bash
   cd packages/backend
   npx convex dev
   # Follow the setup instructions
   ```

2. **Configure Frontend URL**:
   ```bash
   NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
   ```

### 7. Generate Secrets

Generate secure random secrets for production:

```bash
# Generate 256-bit secrets (32 bytes in hex)
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

Use the output for:
```bash
JWT_SECRET=generated-secret-here
PAYMENT_WEBHOOK_SECRET=different-generated-secret-here
```

## Security Checklist

- [ ] **Never commit `.env` or `.env.local` files** to version control
- [ ] **Use different secrets** for JWT and webhook validation
- [ ] **Use mainnet addresses** only for production
- [ ] **Test on devnet first** before going live
- [ ] **Validate wallet address format** (32-44 characters, base58)
- [ ] **Set appropriate CORS origins** for production
- [ ] **Use HTTPS URLs** for RPC endpoints in production

## Pricing Configuration

The system supports flexible pricing through environment variables:

### SOL Pricing
```bash
# Frontend (for display)
NEXT_PUBLIC_SUBSCRIPTION_PRO_PRICE_SOL=0.05
NEXT_PUBLIC_SUBSCRIPTION_PRO_PLUS_PRICE_SOL=0.1

# Backend (for validation)
SUBSCRIPTION_PRO_PRICE_SOL=0.05
SUBSCRIPTION_PRO_PLUS_PRICE_SOL=0.1
```

### USD Approximations (Display Only)
```bash
NEXT_PUBLIC_SUBSCRIPTION_PRO_PRICE_USD=12
NEXT_PUBLIC_SUBSCRIPTION_PRO_PLUS_PRICE_USD=25
```

**Important**: SOL prices are the authoritative values. USD values are for display only.

## Message Limits Configuration

Configure usage limits per subscription tier:

```bash
# Free tier
SUBSCRIPTION_FREE_MESSAGE_LIMIT=50

# Pro tier
SUBSCRIPTION_PRO_MESSAGE_LIMIT=1500
SUBSCRIPTION_PRO_PREMIUM_LIMIT=100

# Pro+ tier  
SUBSCRIPTION_PRO_PLUS_MESSAGE_LIMIT=3000
SUBSCRIPTION_PRO_PLUS_PREMIUM_LIMIT=300
```

## Validation

The system includes built-in validation:

### Frontend Validation
- Solana address format validation (32+ characters)
- Price format validation (positive numbers)
- Network validation (mainnet-beta, testnet, devnet, localhost)

### Backend Validation
- All frontend validations plus:
- Secret length validation (32+ characters)
- JWT configuration validation
- Webhook secret validation

## Troubleshooting

### Common Issues

1. **"Convex Auth not configured"**
   - Run `npx @convex-dev/auth` to initialize auth
   - Check `JWT_PRIVATE_KEY` and `JWKS` are set
   - Verify `SITE_URL` matches your application URL

2. **"OAuth provider not found"**
   - Check OAuth provider environment variables are set correctly
   - Verify callback URLs match your Convex deployment URL
   - Format: `https://your-deployment.convex.site/api/auth/callback/[provider]`

3. **"Email verification failed"**
   - Check `AUTH_RESEND_KEY` is set and valid
   - Verify Resend domain is configured correctly
   - Check email sending limits and quotas

4. **"Payment address not configured"**
   - Check `NEXT_PUBLIC_SOLANA_PAYMENT_ADDRESS` is set
   - Ensure address is valid Solana format

5. **"Environment validation failed"**
   - Check all required variables are set
   - Validate format (URLs, addresses, numbers)

6. **Payment verification fails**
   - Ensure frontend/backend use same payment address
   - Check network configuration matches
   - Verify RPC endpoint is accessible

### Debug Commands

```bash
# Check Convex Auth configuration
npx convex env list | grep AUTH
npx convex env list | grep JWT
npx convex env list | grep SITE_URL

# Enable detailed auth logging (development only)
npx convex env set AUTH_LOG_LEVEL DEBUG

# Test auth endpoints
curl https://your-deployment.convex.site/.well-known/openid-configuration
curl https://your-deployment.convex.site/.well-known/jwks.json

# Check environment loading
cd apps/web && npm run build

# Test Solana connection
cd packages/backend && npx convex run --help

# Validate configuration
node -e "console.log(require('./src/lib/env').convexAuthConfig)"
node -e "console.log(require('./src/lib/env').oauthConfig)"
node -e "console.log(require('./src/lib/env').solanaConfig)"
```

## Deployment

### Environment Variable Priority

1. **Production**: Set via hosting platform (Vercel, Railway, etc.)
2. **Development**: Use `.env.local` files
3. **Testing**: Use test-specific environment files

### Vercel Deployment

1. **Initialize Production Auth**:
   ```bash
   cd packages/backend
   npx @convex-dev/auth --prod
   ```

2. **Set Environment Variables** in Vercel dashboard:
   ```
   # Core app variables
   NEXT_PUBLIC_SOLANA_PAYMENT_ADDRESS=your-address
   NEXT_PUBLIC_CONVEX_URL=your-convex-url
   NEXT_PUBLIC_SOLANA_NETWORK=mainnet-beta
   
   # Convex Auth (automatically set by --prod flag above)
   JWT_PRIVATE_KEY=generated-by-convex-auth
   JWKS=generated-by-convex-auth
   SITE_URL=https://your-production-domain.com
   
   # OAuth Providers (set manually in Vercel if using)
   AUTH_GITHUB_ID=your-github-client-id
   AUTH_GITHUB_SECRET=your-github-client-secret
   AUTH_RESEND_KEY=your-resend-api-key
   ```

3. **Deploy**:
   ```bash
   vercel --prod
   ```

## Support

For configuration issues:

1. **Check the logs** for validation errors
2. **Verify network connectivity** to Solana RPC
3. **Test with devnet** before mainnet
4. **Validate all environment variables** are properly formatted

---

**Security Note**: This configuration handles real cryptocurrency transactions. Always test thoroughly on devnet before deploying to mainnet.